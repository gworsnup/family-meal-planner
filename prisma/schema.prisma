generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Workspace {
  id           String   @id @default(cuid())
  slug         String   @unique
  name         String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  recipes       Recipe[]
  recipeImports RecipeImport[]
  tags          Tag[]
  mealPlanItems MealPlanItem[]
  mealTemplates MealTemplate[]
  shoppingListWeeks ShoppingListWeek[]
  shoppingListSmarts ShoppingListSmart[]
  smartListJobs SmartListJob[]
  users         User[]
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String?
  isAdmin      Boolean  @default(false)
  workspaceId  String?
  hasCreatedWorkspace Boolean @default(false)
  createdAt    DateTime @default(now())

  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  sessions  Session[]
  oauthAccounts OAuthAccount[]

  @@index([workspaceId])
}

model OAuthAccount {
  id String @id @default(cuid())
  provider String
  providerAccountId String
  userId String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id        String   @id @default(cuid())
  tokenHash String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Recipe {
  id          String   @id @default(cuid())
  workspaceId String
  title       String
  sourceName  String?
  sourceUrl   String?
  description String? @db.Text
  photoUrl    String?
  imageSourceUrl String?
  imageStoredAt DateTime?

  prepTimeMinutes  Int?
  cookTimeMinutes  Int?
  totalTimeMinutes Int?

  servings          String?
  yields            String?
  rating            Int?
  isPrivate         Boolean  @default(false)
  isDraft           Boolean  @default(true)
  directions        String?  @db.Text
  directionsStepCount Int? // for future step-by-step UX

  calories     Int?
  proteinGrams Decimal?
  costEstimate String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace       Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  ingredientLines IngredientLine[]
  recipeTags      RecipeTag[]
  import          RecipeImport?
  mealPlanItems   MealPlanItem[]
  mealTemplateItems MealTemplateItem[]

  @@index([workspaceId])
}

model MealPlanItem {
  id          String   @id @default(cuid())
  workspaceId String
  recipeId    String?
  date        DateTime
  type        PlanItemType @default(RECIPE)
  title       String?
  notes       String?  @db.Text
  sortOrder   Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  recipe    Recipe?   @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([workspaceId, date])
  @@unique([workspaceId, date, recipeId])
}

enum PlanItemType {
  RECIPE
  TAKEAWAY
}

enum MealTemplateScope {
  WEEK
  MONTH
}

enum MealTemplateItemKind {
  RECIPE
  TAKEAWAY
}

model MealTemplate {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  scope       MealTemplateScope
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  items     MealTemplateItem[]

  @@index([workspaceId])
}

model MealTemplateItem {
  id         String   @id @default(cuid())
  templateId String
  kind       MealTemplateItemKind
  recipeId   String?
  dayIndex   Int
  mealSlot   String?
  createdAt  DateTime @default(now())

  template MealTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  recipe   Recipe?      @relation(fields: [recipeId], references: [id], onDelete: SetNull)

  @@index([templateId])
  @@unique([templateId, dayIndex, mealSlot])
}

model ShoppingListWeek {
  id          String   @id @default(cuid())
  workspaceId String
  weekStart   DateTime
  version     Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace  Workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  smartLists ShoppingListSmart[]
  smartListJobs SmartListJob[]

  @@unique([workspaceId, weekStart])
  @@index([workspaceId, weekStart])
}

model ShoppingListSmart {
  id          String   @id @default(cuid())
  workspaceId String
  weekId      String
  version     Int
  model       String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  week      ShoppingListWeek @relation(fields: [weekId], references: [id], onDelete: Cascade)
  items     ShoppingListSmartItem[]

  @@index([workspaceId, weekId])
  @@unique([workspaceId, weekId, version])
}

model ShoppingListSmartItem {
  id            String   @id @default(cuid())
  smartListId   String
  category      String
  displayText   String
  quantityValue Decimal?
  quantityUnit  String?
  isEstimated   Boolean  @default(false)
  isMerged      Boolean  @default(false)
  sortKey       Int      @default(0)

  smartList  ShoppingListSmart           @relation(fields: [smartListId], references: [id], onDelete: Cascade)
  provenance ShoppingListSmartProvenance[]
}

model ShoppingListSmartProvenance {
  id           String  @id @default(cuid())
  smartItemId  String
  sourceRecipeId String?
  sourceText   String
  sourceCount  Int?
  notes        String?

  smartItem ShoppingListSmartItem @relation(fields: [smartItemId], references: [id], onDelete: Cascade)
}

model SmartListJob {
  id               String   @id @default(cuid())
  workspaceId      String
  weekId           String
  shoppingListId   String
  shoppingListName String
  smartListId      String?
  status           SmartListJobStatus @default(QUEUED)
  error            String?  @db.Text
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  startedAt        DateTime?
  finishedAt       DateTime?
  notifiedAt       DateTime?

  workspace Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  week      ShoppingListWeek @relation(fields: [weekId], references: [id], onDelete: Cascade)

  @@index([workspaceId, updatedAt])
  @@index([weekId])
  @@index([status])
}

enum SmartListJobStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
}

model RecipeImport {
  id          String   @id @default(cuid())
  workspaceId String
  recipeId    String?  @unique
  sourceUrl   String
  status      String
  importMethod String  @default("fetch")
  error       String?  @db.Text
  raw         Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  recipe    Recipe?   @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([status])
}

model IngredientLine {
  id         String  @id @default(cuid())
  recipeId   String
  position   Int
  amount     String?
  unit       String?
  ingredient String
  notes      String?
  isHeading  Boolean @default(false)

  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
}

model Tag {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  nameNormalized String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  recipeTags RecipeTag[]

  @@unique([workspaceId, nameNormalized])
  @@index([workspaceId])
}

model RecipeTag {
  id       String @id @default(cuid())
  recipeId String
  tagId    String

  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([recipeId, tagId])
  @@index([recipeId])
  @@index([tagId])
}
